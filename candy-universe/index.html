
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ¡ãƒ»ãƒ¦ãƒ‹ãƒãƒ¼ã‚¹ - ç©¶æ¥µã®ã‚¢ãƒ¡ã‚¯ãƒªãƒƒã‚«ãƒ¼</title>
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --dark: #2c3e50;
            --light: #f7f9fc;
            --gold: #ffd700;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--dark);
            color: var(--light);
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
            user-select: none;
        }

        /* å·¦ãƒ‘ãƒãƒ«ï¼šã‚¯ãƒªãƒƒã‚«ãƒ¼ã‚¨ãƒªã‚¢ */
        #click-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #3d566e 0%, var(--dark) 100%);
            position: relative;
        }

        #candy-count-display {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #cps-display {
            font-size: 1.2rem;
            color: #ccc;
            margin-bottom: 2rem;
        }

        #big-candy {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle at 30% 30%, #ff9999, #ff0000);
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.05s;
            position: relative;
            z-index: 10;
        }

        #big-candy:active {
            transform: scale(0.95);
        }

        #big-candy::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60px;
            height: 40px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: rotate(-45deg);
        }

        /* å³ãƒ‘ãƒãƒ«ï¼šã‚·ãƒ§ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        #shop-area {
            width: 400px;
            background-color: rgba(0, 0, 0, 0.3);
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .tab-header {
            display: flex;
            background-color: #222;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }

        .tab-btn.active {
            color: var(--light);
            border-bottom-color: var(--primary);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .item-list {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .building-item, .upgrade-item {
            background-color: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }

        .building-item:hover, .upgrade-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #666;
        }

        .building-item.disabled, .upgrade-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .item-info {
            display: flex;
            flex-direction: column;
        }

        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-cost { color: var(--secondary); font-size: 0.9rem; }
        .item-count { font-size: 1.5rem; font-weight: bold; color: #666; }
        .item-desc { font-size: 0.8rem; color: #aaa; margin-top: 4px; }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
        .click-number {
            position: absolute;
            color: var(--light);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ */
        #golden-candy {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #fff7cc, #ffd700);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--gold);
            cursor: pointer;
            z-index: 100;
            display: none;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--secondary);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 2000;
        }
        
        /* è»¢ç”Ÿãƒœã‚¿ãƒ³ */
        .prestige-btn {
            background: linear-gradient(45deg, #ffd700, #ffa500);
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            color: black;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            transition: 0.2s;
        }
        .prestige-btn:disabled {
            background: #555;
            box-shadow: none;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

<div id="click-area">
    <div id="candy-count-display">0 ã‚¢ãƒ¡</div>
    <div id="cps-display">ç§’é–“ç”Ÿç”£é‡: 0</div>
    <div id="big-candy"></div>
    <div id="golden-candy"></div>
</div>

<div id="shop-area">
    <div class="tab-header">
        <button class="tab-btn active" onclick="switchTab('buildings')">æ–½è¨­</button>
        <button class="tab-btn" onclick="switchTab('upgrades')">å¼·åŒ–</button>
        <button class="tab-btn" onclick="switchTab('settings')">ã‚·ã‚¹ãƒ†ãƒ </button>
    </div>

    <div id="buildings-tab" class="item-list"></div>
    <div id="upgrades-tab" class="item-list" style="display:none;"></div>
    
    <div id="settings-tab" class="item-list" style="display:none; text-align: center; padding: 20px;">
        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <button onclick="saveGame()" style="padding:10px; width:100%; margin-bottom:10px; cursor:pointer;">æ‰‹å‹•ã‚»ãƒ¼ãƒ–</button>
        <div style="font-size:0.8rem; color:#aaa; margin-bottom:20px;">â€»60ç§’ã”ã¨ã«è‡ªå‹•ã‚»ãƒ¼ãƒ–ã•ã‚Œã¾ã™</div>
        <button onclick="hardReset()" style="padding:10px; width:100%; background:#ff4444; color:white; border:none; cursor:pointer;">ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ¶ˆå»</button>
        
        <hr style="border-color:#555; margin: 20px 0;">
        
        <h3 style="color: var(--gold);">ã‚¢ãƒ¡ã®æ˜‡è¯ (Prestige)</h3>
        <p>å…¨ã‚¢ãƒ¡ã‚’æ§ã’ã¦ã€Œè§’ç ‚ç³–ã€ã‚’å¾—ã‚‹ã€‚</p>
        <p>ç²å¾—äºˆå®š: <span id="pending-sugar" style="font-weight:bold; color:var(--gold); font-size:1.2rem;">0</span> å€‹</p>
        <p style="font-size:0.8rem;">(è§’ç ‚ç³–1å€‹ = ç”Ÿç”£åŠ› +10%)</p>
        <button onclick="prestige()" class="prestige-btn" id="prestige-btn" disabled>æ˜‡è¯ã™ã‚‹</button>
        <p style="margin-top:10px;">æ‰€æŒæ•°: <span id="current-sugar">0</span> å€‹</p>
    </div>
</div>

<div id="notification" class="notification">Game Saved</div>

<script>
    /* --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ã¾ã™ï¼‰ --- */
    window.game = {
        candies: 0,
        totalCandies: 0,
        startTime: Date.now(),
        buildings: [],
        upgrades: [],
        sugarCubes: 0,
        prestigeCount: 0
    };

    const UNITS = ["", "ä¸‡", "å„„", "å…†", "äº¬", "å“", "ğ¥±", "ç©£", "æº", "æ¾—", "æ­£", "è¼‰", "æ¥µ", "æ’æ²³æ²™", "é˜¿åƒ§ç¥‡", "é‚£ç”±ä»–", "ä¸å¯æ€è­°", "ç„¡é‡å¤§æ•°"];
    
    // æ–½è¨­å®šç¾©
    const buildingDefs = [
        { id: 'cursor', name: 'è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯', baseCost: 15, baseCps: 0.1, desc: '10ç§’ã«1å›ã‚¯ãƒªãƒƒã‚¯ã€‚' },
        { id: 'grandma', name: 'ãŠã°ã‚ã¡ã‚ƒã‚“', baseCost: 100, baseCps: 1, desc: 'å„ªã—ã„æ‰‹ä½œã‚Šã‚¢ãƒ¡ã€‚' },
        { id: 'farm', name: 'ã‚¢ãƒ¡è¾²åœ’', baseCost: 1100, baseCps: 8, desc: 'ç•‘ã‹ã‚‰ã‚¢ãƒ¡ã‚’åç©«ã€‚' },
        { id: 'factory', name: 'ã‚¢ãƒ¡å·¥å ´', baseCost: 12000, baseCps: 47, desc: 'ãƒ™ãƒ«ãƒˆã‚³ãƒ³ãƒ™ã‚¢ã§å¤§é‡ç”Ÿç”£ã€‚' },
        { id: 'mine', name: 'ã‚¢ãƒ¡é‰±å±±', baseCost: 130000, baseCps: 260, desc: 'åœ°ä¸‹æ·±ãã®ã‚¢ãƒ¡é‰±è„ˆã€‚' },
        { id: 'lab', name: 'éŒ¬é‡‘è¡“ãƒ©ãƒœ', baseCost: 1400000, baseCps: 1400, desc: 'ç§‘å­¦ã®åŠ›ã§ã‚¢ãƒ¡ã‚’ç”Ÿæˆã€‚' },
        { id: 'portal', name: 'ã‚¢ãƒ¡ãƒãƒ¼ã‚¿ãƒ«', baseCost: 20000000, baseCps: 7800, desc: 'ç•°æ¬¡å…ƒã‹ã‚‰ã®è¼¸é€ã€‚' },
        { id: 'time', name: 'ã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³', baseCost: 330000000, baseCps: 44000, desc: 'æœªæ¥ã®ã‚¢ãƒ¡ã‚’å‰å€Ÿã‚Šã€‚' },
        { id: 'prism', name: 'ãƒ—ãƒªã‚ºãƒ ', baseCost: 5100000000, baseCps: 260000, desc: 'å…‰ã‚’ç‰©è³ªåŒ–ã€‚' },
        { id: 'universe', name: 'ã‚¢ãƒ¡éŠ€æ²³', baseCost: 75000000000, baseCps: 1600000, desc: 'æƒ‘æ˜Ÿè‡ªä½“ãŒã‚¢ãƒ¡ã§å‡ºæ¥ã¦ã„ã‚‹ã€‚' },
        { id: 'god', name: 'å‰µé€ ç¥', baseCost: 1000000000000, baseCps: 10000000, desc: 'ã€Œã‚¢ãƒ¡ã‚ã‚Œã€' }
    ];

    // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å®šç¾©
    const upgradeDefs = [
        { id: 'click1', name: 'å¼·åŒ–æŒ‡', cost: 500, type: 'click', mult: 2, desc: 'ã‚¯ãƒªãƒƒã‚¯2å€', trigger: 100 },
        { id: 'click2', name: 'ãƒ€ã‚¤ãƒ¤æŒ‡', cost: 50000, type: 'click', mult: 2, desc: 'ã‚¯ãƒªãƒƒã‚¯ã•ã‚‰ã«2å€', trigger: 10000 },
        { id: 'g_boost1', name: 'è€çœ¼é¡', cost: 1000, type: 'building', buildingId: 'grandma', mult: 2, desc: 'ãŠã°ã‚ã¡ã‚ƒã‚“2å€', trigger: 10 },
        { id: 'f_boost1', name: 'åŒ–å­¦è‚¥æ–™', cost: 11000, type: 'building', buildingId: 'farm', mult: 2, desc: 'è¾²åœ’2å€', trigger: 10 },
        { id: 'fact_boost1', name: 'ãƒ­ãƒœãƒƒãƒˆåŒ–', cost: 120000, type: 'building', buildingId: 'factory', mult: 2, desc: 'å·¥å ´2å€', trigger: 10 },
        { id: 'mine_boost1', name: 'è¶…ç¡¬ãƒ‰ãƒªãƒ«', cost: 1300000, type: 'building', buildingId: 'mine', mult: 2, desc: 'é‰±å±±2å€', trigger: 10 },
        { id: 'all_boost', name: 'ç ‚ç³–ã®å¥‡è·¡', cost: 1000000000, type: 'global', mult: 1.1, desc: 'å…¨ç”Ÿç”£é‡+10%', trigger: 1000000 }
    ];

    /* --- åˆæœŸåŒ– --- */
    function init() {
        loadGame(); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
        
        // ãƒ‡ãƒ¼ã‚¿è£œæ­£ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å¯¾ç­–ï¼‰
        if (game.buildings.length !== buildingDefs.length) {
            buildingDefs.forEach((def, index) => {
                if (!game.buildings[index]) game.buildings[index] = { count: 0 };
            });
        }
        
        createUI();
        requestAnimationFrame(gameLoop);
        
        // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼ˆ60ç§’ã”ã¨ï¼‰
        setInterval(saveGame, 60000);
        
        // ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚­ãƒ£ãƒ³ãƒ‡ã‚£æŠ½é¸
        setInterval(trySpawnGoldenCandy, 1000);

        // ãƒãƒ¼ãƒˆèª¬æ˜ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        printCheatCodes();
    }

    /* --- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ --- */
    function saveGame() {
        try {
            localStorage.setItem('CandyUniverseSave', JSON.stringify(window.game));
            showNotification("Game Saved");
        } catch (e) {
            console.error("Save failed:", e);
        }
    }

    function loadGame() {
        const save = localStorage.getItem('CandyUniverseSave');
        if (save) {
            try {
                const savedGame = JSON.parse(save);
                window.game = { ...window.game, ...savedGame };
            } catch (e) {
                console.error("Save file corrupted, starting new game.");
            }
        }
    }

    /* --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ --- */
    function getBuildingCost(index) {
        const base = buildingDefs[index].baseCost;
        const count = game.buildings[index].count;
        return Math.floor(base * Math.pow(1.15, count));
    }

    function getCps() {
        let cps = 0;
        buildingDefs.forEach((def, index) => {
            let mult = 1;
            upgradeDefs.forEach(u => {
                if (game.upgrades.includes(u.id) && u.type === 'building' && u.buildingId === def.id) mult *= u.mult;
                if (game.upgrades.includes(u.id) && u.type === 'global') mult *= u.mult;
            });
            cps += (def.baseCps * game.buildings[index].count * mult);
        });
        
        // è»¢ç”Ÿãƒœãƒ¼ãƒŠã‚¹
        const prestigeMult = 1 + (game.sugarCubes * 0.1);
        return cps * prestigeMult * (feverMode ? 7 : 1);
    }

    function getClickPower() {
        let power = 1;
        const totalBuildings = game.buildings.reduce((a, b) => a + b.count, 0);
        power += totalBuildings * 0.5; // æ–½è¨­æ•°ã§ã‚¯ãƒªãƒƒã‚¯å¼·åŒ–
        
        upgradeDefs.forEach(u => {
            if (game.upgrades.includes(u.id) && u.type === 'click') power *= u.mult;
            if (game.upgrades.includes(u.id) && u.type === 'global') power *= u.mult;
        });

        const prestigeMult = 1 + (game.sugarCubes * 0.1);
        return power * prestigeMult * (feverMode ? 77 : 1);
    }

    /* --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— --- */
    let lastTime = Date.now();
    let feverMode = false;
    let feverTimer = 0;

    function gameLoop() {
        const now = Date.now();
        const dt = (now - lastTime) / 1000;
        lastTime = now;

        const cps = getCps();
        if (cps > 0) {
            game.candies += cps * dt;
            game.totalCandies += cps * dt;
            checkUnlocks();
        }

        if (feverMode) {
            feverTimer -= dt;
            if (feverTimer <= 0) {
                feverMode = false;
                document.body.style.boxShadow = "none";
            }
        }

        updateDisplay(cps);
        updateButtons();
        requestAnimationFrame(gameLoop);
    }

    /* --- UIæ›´æ–° --- */
    function createUI() {
        const bTab = document.getElementById('buildings-tab');
        bTab.innerHTML = '';
        buildingDefs.forEach((def, index) => {
            const div = document.createElement('div');
            div.className = 'building-item';
            div.id = `b-item-${index}`;
            div.onclick = () => buyBuilding(index);
            div.innerHTML = `
                <div class="item-info">
                    <span class="item-name">${def.name}</span>
                    <span class="item-cost" id="b-cost-${index}">Cost: ${formatNumber(getBuildingCost(index))}</span>
                    <span class="item-desc">${def.desc}</span>
                </div>
                <span class="item-count" id="b-count-${index}">${game.buildings[index].count}</span>
            `;
            bTab.appendChild(div);
        });
        updateUpgradesUI();
    }

    function updateDisplay(cps = getCps()) {
        document.getElementById('candy-count-display').innerText = `${formatNumber(game.candies)} ã‚¢ãƒ¡`;
        document.getElementById('cps-display').innerText = `ç§’é–“: ${formatNumber(cps)}`;
        document.title = `${formatNumber(game.candies)} ã‚¢ãƒ¡ - Candy Universe`;

        // è»¢ç”Ÿé–¢é€£
        const pending = calculatePrestige();
        document.getElementById('pending-sugar').innerText = formatNumber(pending);
        document.getElementById('current-sugar').innerText = formatNumber(game.sugarCubes);
        
        const prestigeBtn = document.getElementById('prestige-btn');
        prestigeBtn.disabled = pending <= 0;
    }

    function updateUpgradesUI() {
        const uTab = document.getElementById('upgrades-tab');
        uTab.innerHTML = '';
        let hasItems = false;
        upgradeDefs.forEach((def, index) => {
            if (game.upgrades.includes(def.id)) return;
            if (game.totalCandies < def.trigger) return;

            hasItems = true;
            const div = document.createElement('div');
            div.className = 'upgrade-item';
            div.id = `u-item-${index}`;
            div.onclick = () => buyUpgrade(index);
            div.innerHTML = `
                <div class="item-info">
                    <span class="item-name">${def.name}</span>
                    <span class="item-cost">Cost: ${formatNumber(def.cost)}</span>
                    <span class="item-desc">${def.desc}</span>
                </div>
            `;
            uTab.appendChild(div);
        });
        if (!hasItems) uTab.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ç¾åœ¨è³¼å…¥å¯èƒ½ãªå¼·åŒ–ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    }

    function updateButtons() {
        buildingDefs.forEach((_, index) => {
            const btn = document.getElementById(`b-item-${index}`);
            const cost = getBuildingCost(index);
            if (game.candies < cost) btn.classList.add('disabled');
            else btn.classList.remove('disabled');
        });
        
        const upItems = document.querySelectorAll('.upgrade-item');
        upItems.forEach(item => {
            const index = item.id.split('-')[2];
            if(index !== undefined) {
                 const cost = upgradeDefs[index].cost;
                 if(game.candies < cost) item.classList.add('disabled');
                 else item.classList.remove('disabled');
            }
        });
    }

    /* --- æ“ä½œç³» --- */
    document.getElementById('big-candy').addEventListener('mousedown', (e) => {
        const amount = getClickPower();
        game.candies += amount;
        game.totalCandies += amount;
        spawnFloatingText(e.clientX, e.clientY, `+${formatNumber(amount)}`);
        playClickSound();
        checkUnlocks();
    });

    function buyBuilding(index) {
        const cost = getBuildingCost(index);
        if (game.candies >= cost) {
            game.candies -= cost;
            game.buildings[index].count++;
            document.getElementById(`b-cost-${index}`).innerText = `Cost: ${formatNumber(getBuildingCost(index))}`;
            document.getElementById(`b-count-${index}`).innerText = game.buildings[index].count;
            updateDisplay();
        }
    }

    function buyUpgrade(index) {
        const def = upgradeDefs[index];
        if (game.candies >= def.cost) {
            game.candies -= def.cost;
            game.upgrades.push(def.id);
            updateUpgradesUI();
            updateDisplay();
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.item-list').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).style.display = 'block';
        
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName==='buildings') btns[0].classList.add('active');
        if(tabName==='upgrades') btns[1].classList.add('active');
        if(tabName==='settings') btns[2].classList.add('active');
        
        if(tabName==='upgrades') updateUpgradesUI();
    }

    /* --- ã‚¤ãƒ™ãƒ³ãƒˆ & è»¢ç”Ÿ --- */
    function checkUnlocks() {
        if (Math.random() < 0.1) updateUpgradesUI();
    }

    function trySpawnGoldenCandy() {
        if (feverMode || document.getElementById('golden-candy').style.display === 'block') return;
        if (Math.random() < 0.005) { // 0.5% chance per second
            const golden = document.getElementById('golden-candy');
            golden.style.left = Math.random() * (window.innerWidth - 100) + 'px';
            golden.style.top = Math.random() * (window.innerHeight - 100) + 'px';
            golden.style.display = 'block';
            setTimeout(() => golden.style.display = 'none', 10000);
        }
    }

    document.getElementById('golden-candy').onclick = function() {
        this.style.display = 'none';
        feverMode = true;
        feverTimer = 15;
        document.body.style.boxShadow = "inset 0 0 100px var(--gold)";
        showNotification("FEVER! x7å€");
        game.candies += getCps() * 600;
    };

    function calculatePrestige() {
        if (game.totalCandies < 1000000) return 0;
        const potential = Math.floor(Math.cbrt(game.totalCandies / 1000000));
        return Math.max(0, potential - game.sugarCubes);
    }

    function prestige() {
        const gain = calculatePrestige();
        if (gain <= 0) return;
        if (!confirm(`è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\nè§’ç ‚ç³– +${gain}`)) return;

        game.sugarCubes += gain;
        game.candies = 0;
        game.buildings.forEach(b => b.count = 0);
        game.upgrades = [];
        saveGame();
        location.reload();
    }

    function hardReset() {
        if (confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('CandyUniverseSave');
            location.reload();
        }
    }

    /* --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
    function formatNumber(num) {
        if (num < 10000) return Math.floor(num).toLocaleString();
        let unitIndex = 0;
        let n = Math.floor(num);
        while (n >= 10000 && unitIndex < UNITS.length - 1) {
            n /= 10000;
            unitIndex++;
        }
        return n.toFixed(2) + UNITS[unitIndex];
    }

    function showNotification(msg) {
        const el = document.getElementById('notification');
        el.innerText = msg;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 2000);
    }

    function spawnFloatingText(x, y, text) {
        const el = document.createElement('div');
        el.className = 'click-number';
        el.innerText = text;
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playClickSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800 + Math.random() * 200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
    }

    /* =========================================
       ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (Developer Tools API)
       ========================================= */
    
    // ãƒãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’ã¾ã¨ã‚ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    window.Cheat = {
        // ã‚¢ãƒ¡ã‚’å¤§é‡ã«è¿½åŠ 
        addCandies: function(amount) {
            window.game.candies += amount;
            window.game.totalCandies += amount;
            updateDisplay();
            console.log(`ğŸ­ ${formatNumber(amount)} ã‚¢ãƒ¡ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ç¾åœ¨: ${formatNumber(window.game.candies)}`);
        },
        
        // è§’ç ‚ç³–ï¼ˆè»¢ç”Ÿé€šè²¨ï¼‰ã‚’è¿½åŠ 
        addSugar: function(amount) {
            window.game.sugarCubes += amount;
            updateDisplay();
            console.log(`ğŸ§Š è§’ç ‚ç³– ${amount} å€‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ç”Ÿç”£å€ç‡ãŒä¸ŠãŒã‚Šã¾ã—ãŸï¼`);
        },
        
        // ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ã‚’å¼·åˆ¶å‡ºç¾
        spawnGolden: function() {
            const golden = document.getElementById('golden-candy');
            golden.style.left = '50%';
            golden.style.top = '50%';
            golden.style.display = 'block';
            console.log(`âœ¨ ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ã‚’å‡ºç¾ã•ã›ã¾ã—ãŸã€‚`);
        },

        // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•
        fever: function() {
            feverMode = true;
            feverTimer = 60; // 60ç§’
            document.body.style.boxShadow = "inset 0 0 100px var(--gold)";
            console.log(`ğŸ”¥ ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•ï¼(60ç§’é–“)`);
        },

        // æ–½è¨­ã‚’å…¨éƒ¨100å€‹ãšã¤è²·ã†
        richMan: function() {
            window.game.buildings.forEach(b => b.count += 100);
            updateDisplay();
            createUI(); // è¡¨ç¤ºæ›´æ–°
            console.log(`ğŸ­ å…¨æ–½è¨­ã‚’100å€‹ãšã¤è¿½åŠ ã—ã¾ã—ãŸã€‚`);
        }
    };

    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸ã®æ¡ˆå†…è¡¨ç¤º
    function printCheatCodes() {
        const styleTitle = "color: #ff6b6b; font-size: 20px; font-weight: bold; text-shadow: 1px 1px black;";
        const styleCode = "color: #4ecdc4; font-weight: bold; background: #222; padding: 2px 5px; border-radius: 3px;";
        const styleDesc = "color: #ccc;";

        console.log("%cğŸ¬ Candy Universe Developer Console ğŸ¬", styleTitle);
        console.log("%cä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œã§ãã¾ã™:", "color: #fff; margin-bottom: 10px;");
        
        console.log(`%cCheat.addCandies(100000000)%c - ã‚¢ãƒ¡ã‚’1å„„å€‹è¿½åŠ `, styleCode, styleDesc);
        console.log(`%cCheat.addSugar(1000)%c - è§’ç ‚ç³–ã‚’1000å€‹è¿½åŠ ï¼ˆæ”»æ’ƒåŠ›æ¿€å¢—ï¼‰`, styleCode, styleDesc);
        console.log(`%cCheat.spawnGolden()%c - ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ã‚’å¬å–š`, styleCode, styleDesc);
        console.log(`%cCheat.fever()%c - 60ç§’é–“ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰`, styleCode, styleDesc);
        console.log(`%cCheat.richMan()%c - å…¨æ–½è¨­+100å€‹`, styleCode, styleDesc);
        console.log("%c-----------------------------------", "color: #555;");
    }

    init();

</script>
</body>
</html>
